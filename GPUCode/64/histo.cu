#include <stdio.h>
#include "histo.h"

__global__ void histo_kernel(int histo_size, double reqNumThreads, int numPixPerThread, int numElemPerThread, int imgDataBufferSize, float *dev_imgDataBuffer, int nbBinsPerDim, int binSize, int *dev_histo){
    int stride = 0;
	int const part_histo_size = 12288;
	 int stride_offset = part_histo_size;
	 int histo_count = 1;

	__shared__ int temp_histo[part_histo_size];

	while(histo_count <= (((histo_size - 1)/part_histo_size)+1)){
    	temp_histo[threadIdx.x * 192] = 0;
    	temp_histo[threadIdx.x * 192 + 1] = 0;
    	temp_histo[threadIdx.x * 192 + 2] = 0;
    	temp_histo[threadIdx.x * 192 + 3] = 0;
    	temp_histo[threadIdx.x * 192 + 4] = 0;
    	temp_histo[threadIdx.x * 192 + 5] = 0;
    	temp_histo[threadIdx.x * 192 + 6] = 0;
    	temp_histo[threadIdx.x * 192 + 7] = 0;
    	temp_histo[threadIdx.x * 192 + 8] = 0;
    	temp_histo[threadIdx.x * 192 + 9] = 0;
    	temp_histo[threadIdx.x * 192 + 10] = 0;
    	temp_histo[threadIdx.x * 192 + 11] = 0;
    	temp_histo[threadIdx.x * 192 + 12] = 0;
    	temp_histo[threadIdx.x * 192 + 13] = 0;
    	temp_histo[threadIdx.x * 192 + 14] = 0;
    	temp_histo[threadIdx.x * 192 + 15] = 0;
    	temp_histo[threadIdx.x * 192 + 16] = 0;
    	temp_histo[threadIdx.x * 192 + 17] = 0;
    	temp_histo[threadIdx.x * 192 + 18] = 0;
    	temp_histo[threadIdx.x * 192 + 19] = 0;
    	temp_histo[threadIdx.x * 192 + 20] = 0;
    	temp_histo[threadIdx.x * 192 + 21] = 0;
    	temp_histo[threadIdx.x * 192 + 22] = 0;
    	temp_histo[threadIdx.x * 192 + 23] = 0;
    	temp_histo[threadIdx.x * 192 + 24] = 0;
    	temp_histo[threadIdx.x * 192 + 25] = 0;
    	temp_histo[threadIdx.x * 192 + 26] = 0;
    	temp_histo[threadIdx.x * 192 + 27] = 0;
    	temp_histo[threadIdx.x * 192 + 28] = 0;
    	temp_histo[threadIdx.x * 192 + 29] = 0;
    	temp_histo[threadIdx.x * 192 + 30] = 0;
    	temp_histo[threadIdx.x * 192 + 31] = 0;
    	temp_histo[threadIdx.x * 192 + 32] = 0;
    	temp_histo[threadIdx.x * 192 + 33] = 0;
    	temp_histo[threadIdx.x * 192 + 34] = 0;
    	temp_histo[threadIdx.x * 192 + 35] = 0;
    	temp_histo[threadIdx.x * 192 + 36] = 0;
    	temp_histo[threadIdx.x * 192 + 37] = 0;
    	temp_histo[threadIdx.x * 192 + 38] = 0;
    	temp_histo[threadIdx.x * 192 + 39] = 0;
    	temp_histo[threadIdx.x * 192 + 40] = 0;
    	temp_histo[threadIdx.x * 192 + 41] = 0;
    	temp_histo[threadIdx.x * 192 + 42] = 0;
    	temp_histo[threadIdx.x * 192 + 43] = 0;
    	temp_histo[threadIdx.x * 192 + 44] = 0;
    	temp_histo[threadIdx.x * 192 + 45] = 0;
    	temp_histo[threadIdx.x * 192 + 46] = 0;
    	temp_histo[threadIdx.x * 192 + 47] = 0;
    	temp_histo[threadIdx.x * 192 + 48] = 0;
    	temp_histo[threadIdx.x * 192 + 49] = 0;
    	temp_histo[threadIdx.x * 192 + 50] = 0;
    	temp_histo[threadIdx.x * 192 + 51] = 0;
    	temp_histo[threadIdx.x * 192 + 52] = 0;
    	temp_histo[threadIdx.x * 192 + 53] = 0;
    	temp_histo[threadIdx.x * 192 + 54] = 0;
    	temp_histo[threadIdx.x * 192 + 55] = 0;
    	temp_histo[threadIdx.x * 192 + 56] = 0;
    	temp_histo[threadIdx.x * 192 + 57] = 0;
    	temp_histo[threadIdx.x * 192 + 58] = 0;
    	temp_histo[threadIdx.x * 192 + 59] = 0;
    	temp_histo[threadIdx.x * 192 + 60] = 0;
    	temp_histo[threadIdx.x * 192 + 61] = 0;
    	temp_histo[threadIdx.x * 192 + 62] = 0;
    	temp_histo[threadIdx.x * 192 + 63] = 0;
    	temp_histo[threadIdx.x * 192 + 64] = 0;
    	temp_histo[threadIdx.x * 192 + 65] = 0;
    	temp_histo[threadIdx.x * 192 + 66] = 0;
    	temp_histo[threadIdx.x * 192 + 67] = 0;
    	temp_histo[threadIdx.x * 192 + 68] = 0;
    	temp_histo[threadIdx.x * 192 + 69] = 0;
    	temp_histo[threadIdx.x * 192 + 70] = 0;
    	temp_histo[threadIdx.x * 192 + 71] = 0;
    	temp_histo[threadIdx.x * 192 + 72] = 0;
    	temp_histo[threadIdx.x * 192 + 73] = 0;
    	temp_histo[threadIdx.x * 192 + 74] = 0;
    	temp_histo[threadIdx.x * 192 + 75] = 0;
    	temp_histo[threadIdx.x * 192 + 76] = 0;
    	temp_histo[threadIdx.x * 192 + 77] = 0;
    	temp_histo[threadIdx.x * 192 + 78] = 0;
    	temp_histo[threadIdx.x * 192 + 79] = 0;
    	temp_histo[threadIdx.x * 192 + 80] = 0;
    	temp_histo[threadIdx.x * 192 + 81] = 0;
    	temp_histo[threadIdx.x * 192 + 82] = 0;
    	temp_histo[threadIdx.x * 192 + 83] = 0;
    	temp_histo[threadIdx.x * 192 + 84] = 0;
    	temp_histo[threadIdx.x * 192 + 85] = 0;
    	temp_histo[threadIdx.x * 192 + 86] = 0;
    	temp_histo[threadIdx.x * 192 + 87] = 0;
    	temp_histo[threadIdx.x * 192 + 88] = 0;
    	temp_histo[threadIdx.x * 192 + 89] = 0;
    	temp_histo[threadIdx.x * 192 + 90] = 0;
    	temp_histo[threadIdx.x * 192 + 91] = 0;
    	temp_histo[threadIdx.x * 192 + 92] = 0;
    	temp_histo[threadIdx.x * 192 + 93] = 0;
    	temp_histo[threadIdx.x * 192 + 95] = 0;
    	temp_histo[threadIdx.x * 192 + 96] = 0;
    	temp_histo[threadIdx.x * 192 + 97] = 0;
    	temp_histo[threadIdx.x * 192 + 98] = 0;
    	temp_histo[threadIdx.x * 192 + 99] = 0;
    	temp_histo[threadIdx.x * 192 + 100] = 0;
    	temp_histo[threadIdx.x * 192 + 101] = 0;
    	temp_histo[threadIdx.x * 192 + 102] = 0;
    	temp_histo[threadIdx.x * 192 + 103] = 0;
    	temp_histo[threadIdx.x * 192 + 104] = 0;
    	temp_histo[threadIdx.x * 192 + 105] = 0;
    	temp_histo[threadIdx.x * 192 + 106] = 0;
    	temp_histo[threadIdx.x * 192 + 107] = 0;
    	temp_histo[threadIdx.x * 192 + 108] = 0;
    	temp_histo[threadIdx.x * 192 + 109] = 0;
    	temp_histo[threadIdx.x * 192 + 110] = 0;
    	temp_histo[threadIdx.x * 192 + 111] = 0;
    	temp_histo[threadIdx.x * 192 + 112] = 0;
    	temp_histo[threadIdx.x * 192 + 113] = 0;
    	temp_histo[threadIdx.x * 192 + 114] = 0;
    	temp_histo[threadIdx.x * 192 + 115] = 0;
    	temp_histo[threadIdx.x * 192 + 116] = 0;
    	temp_histo[threadIdx.x * 192 + 117] = 0;
    	temp_histo[threadIdx.x * 192 + 118] = 0;
    	temp_histo[threadIdx.x * 192 + 119] = 0;
    	temp_histo[threadIdx.x * 192 + 120] = 0;
    	temp_histo[threadIdx.x * 192 + 121] = 0;
    	temp_histo[threadIdx.x * 192 + 122] = 0;
    	temp_histo[threadIdx.x * 192 + 123] = 0;
    	temp_histo[threadIdx.x * 192 + 124] = 0;
    	temp_histo[threadIdx.x * 192 + 125] = 0;
    	temp_histo[threadIdx.x * 192 + 126] = 0;
    	temp_histo[threadIdx.x * 192 + 127] = 0;
    	temp_histo[threadIdx.x * 192 + 128] = 0;
    	temp_histo[threadIdx.x * 192 + 129] = 0;
    	temp_histo[threadIdx.x * 192 + 130] = 0;
    	temp_histo[threadIdx.x * 192 + 131] = 0;
    	temp_histo[threadIdx.x * 192 + 132] = 0;
    	temp_histo[threadIdx.x * 192 + 133] = 0;
    	temp_histo[threadIdx.x * 192 + 134] = 0;
    	temp_histo[threadIdx.x * 192 + 135] = 0;
    	temp_histo[threadIdx.x * 192 + 136] = 0;
    	temp_histo[threadIdx.x * 192 + 137] = 0;
    	temp_histo[threadIdx.x * 192 + 138] = 0;
    	temp_histo[threadIdx.x * 192 + 139] = 0;
    	temp_histo[threadIdx.x * 192 + 140] = 0;
    	temp_histo[threadIdx.x * 192 + 141] = 0;
    	temp_histo[threadIdx.x * 192 + 142] = 0;
    	temp_histo[threadIdx.x * 192 + 143] = 0;
    	temp_histo[threadIdx.x * 192 + 144] = 0;
    	temp_histo[threadIdx.x * 192 + 145] = 0;
    	temp_histo[threadIdx.x * 192 + 146] = 0;
    	temp_histo[threadIdx.x * 192 + 147] = 0;
    	temp_histo[threadIdx.x * 192 + 148] = 0;
    	temp_histo[threadIdx.x * 192 + 149] = 0;
    	temp_histo[threadIdx.x * 192 + 150] = 0;
    	temp_histo[threadIdx.x * 192 + 151] = 0;
    	temp_histo[threadIdx.x * 192 + 152] = 0;
    	temp_histo[threadIdx.x * 192 + 153] = 0;
    	temp_histo[threadIdx.x * 192 + 154] = 0;
    	temp_histo[threadIdx.x * 192 + 155] = 0;
    	temp_histo[threadIdx.x * 192 + 156] = 0;
    	temp_histo[threadIdx.x * 192 + 157] = 0;
    	temp_histo[threadIdx.x * 192 + 158] = 0;
    	temp_histo[threadIdx.x * 192 + 159] = 0;
    	temp_histo[threadIdx.x * 192 + 160] = 0;
    	temp_histo[threadIdx.x * 192 + 161] = 0;
    	temp_histo[threadIdx.x * 192 + 162] = 0;
    	temp_histo[threadIdx.x * 192 + 163] = 0;
    	temp_histo[threadIdx.x * 192 + 164] = 0;
    	temp_histo[threadIdx.x * 192 + 165] = 0;
    	temp_histo[threadIdx.x * 192 + 166] = 0;
    	temp_histo[threadIdx.x * 192 + 167] = 0;
    	temp_histo[threadIdx.x * 192 + 168] = 0;
    	temp_histo[threadIdx.x * 192 + 169] = 0;
    	temp_histo[threadIdx.x * 192 + 170] = 0;
    	temp_histo[threadIdx.x * 192 + 171] = 0;
    	temp_histo[threadIdx.x * 192 + 172] = 0;
    	temp_histo[threadIdx.x * 192 + 173] = 0;
    	temp_histo[threadIdx.x * 192 + 174] = 0;
    	temp_histo[threadIdx.x * 192 + 175] = 0;
    	temp_histo[threadIdx.x * 192 + 176] = 0;
    	temp_histo[threadIdx.x * 192 + 177] = 0;
    	temp_histo[threadIdx.x * 192 + 178] = 0;
    	temp_histo[threadIdx.x * 192 + 179] = 0;
    	temp_histo[threadIdx.x * 192 + 180] = 0;
    	temp_histo[threadIdx.x * 192 + 181] = 0;
    	temp_histo[threadIdx.x * 192 + 182] = 0;
    	temp_histo[threadIdx.x * 192 + 183] = 0;
    	temp_histo[threadIdx.x * 192 + 184] = 0;
    	temp_histo[threadIdx.x * 192 + 185] = 0;
    	temp_histo[threadIdx.x * 192 + 186] = 0;
    	temp_histo[threadIdx.x * 192 + 187] = 0;
    	temp_histo[threadIdx.x * 192 + 188] = 0;
    	temp_histo[threadIdx.x * 192 + 189] = 0;
    	temp_histo[threadIdx.x * 192 + 190] = 0;
    	temp_histo[threadIdx.x * 192 + 191] = 0;

    	__syncthreads();

    	int i = threadIdx.x + blockIdx.x * blockDim.x;
    	int offset = blockDim.x * gridDim.x;
    	while(i < reqNumThreads){
    	//	int j = 0;
    	//	while((j < numPixPerThread) && (((i * numElemPerThread)+(j * 3)) < imgDataBufferSize)){
    			//printf("Inside while\n");
    			float L = dev_imgDataBuffer[(i * numElemPerThread)];
    			float a = dev_imgDataBuffer[(i * numElemPerThread + 1)];
    			float b = dev_imgDataBuffer[(i * numElemPerThread + 2)];
    			int idx = ((((int)round(L)-0)/binSize)*nbBinsPerDim*nbBinsPerDim)+
    					(((int)round(a)+127)/binSize)*nbBinsPerDim +
    					((int)round(b)+127)/binSize;
    			/**checking if the idx lies between the current range of histogram**/
    			if(idx >= stride && idx < stride_offset){
    				int finalIdx = idx - stride;
    				atomicAdd(&temp_histo[finalIdx],1);
    			}//end of if condition
    		//	j++;
    		//}//end of while loop calculating number of n values per thread
    		i += offset;
    	}//end of image scan while condition
    	__syncthreads();

    		atomicAdd(&dev_histo[(threadIdx.x * 192) + stride], temp_histo[threadIdx.x * 192 + 0]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 1) + stride], temp_histo[threadIdx.x * 192 + 1]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 2) + stride], temp_histo[threadIdx.x * 192 + 2]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 3) + stride], temp_histo[threadIdx.x * 192 + 3]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 4) + stride], temp_histo[threadIdx.x * 192 + 4]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 5) + stride], temp_histo[threadIdx.x * 192 + 5]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 6) + stride], temp_histo[threadIdx.x * 192 + 6]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 7) + stride], temp_histo[threadIdx.x * 192 + 7]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 8) + stride], temp_histo[threadIdx.x * 192 + 8]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 9) + stride], temp_histo[threadIdx.x * 192 + 9]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 10) + stride], temp_histo[threadIdx.x * 192 + 10]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 11) + stride], temp_histo[threadIdx.x * 192 + 11]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 12) + stride], temp_histo[threadIdx.x * 192 + 12]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 13) + stride], temp_histo[threadIdx.x * 192 + 13]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 14) + stride], temp_histo[threadIdx.x * 192 + 14]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 15) + stride], temp_histo[threadIdx.x * 192 + 15]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 16) + stride], temp_histo[threadIdx.x * 192 + 16]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 17) + stride], temp_histo[threadIdx.x * 192 + 17]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 18) + stride], temp_histo[threadIdx.x * 192 + 18]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 19) + stride], temp_histo[threadIdx.x * 192 + 19]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 20) + stride], temp_histo[threadIdx.x * 192 + 20]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 21) + stride], temp_histo[threadIdx.x * 192 + 21]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 22) + stride], temp_histo[threadIdx.x * 192 + 22]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 23) + stride], temp_histo[threadIdx.x * 192 + 23]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 24) + stride], temp_histo[threadIdx.x * 192 + 24]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 25) + stride], temp_histo[threadIdx.x * 192 + 25]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 26) + stride], temp_histo[threadIdx.x * 192 + 26]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 27) + stride], temp_histo[threadIdx.x * 192 + 27]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 28) + stride], temp_histo[threadIdx.x * 192 + 28]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 29) + stride], temp_histo[threadIdx.x * 192 + 29]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 30) + stride], temp_histo[threadIdx.x * 192 + 30]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 31) + stride], temp_histo[threadIdx.x * 192 + 31]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 32) + stride], temp_histo[threadIdx.x * 192 + 32]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 33) + stride], temp_histo[threadIdx.x * 192 + 33]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 34) + stride], temp_histo[threadIdx.x * 192 + 34]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 35) + stride], temp_histo[threadIdx.x * 192 + 35]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 36) + stride], temp_histo[threadIdx.x * 192 + 36]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 37) + stride], temp_histo[threadIdx.x * 192 + 37]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 38) + stride], temp_histo[threadIdx.x * 192 + 38]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 39) + stride], temp_histo[threadIdx.x * 192 + 39]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 40) + stride], temp_histo[threadIdx.x * 192 + 40]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 41) + stride], temp_histo[threadIdx.x * 192 + 41]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 42) + stride], temp_histo[threadIdx.x * 192 + 42]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 43) + stride], temp_histo[threadIdx.x * 192 + 43]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 44) + stride], temp_histo[threadIdx.x * 192 + 44]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 45) + stride], temp_histo[threadIdx.x * 192 + 45]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 46) + stride], temp_histo[threadIdx.x * 192 + 46]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 47) + stride], temp_histo[threadIdx.x * 192 + 47]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 48) + stride], temp_histo[threadIdx.x * 192 + 48]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 49) + stride], temp_histo[threadIdx.x * 192 + 49]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 50) + stride], temp_histo[threadIdx.x * 192 + 50]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 51) + stride], temp_histo[threadIdx.x * 192 + 51]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 52) + stride], temp_histo[threadIdx.x * 192 + 52]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 53) + stride], temp_histo[threadIdx.x * 192 + 53]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 54) + stride], temp_histo[threadIdx.x * 192 + 54]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 55) + stride], temp_histo[threadIdx.x * 192 + 55]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 56) + stride], temp_histo[threadIdx.x * 192 + 56]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 57) + stride], temp_histo[threadIdx.x * 192 + 57]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 58) + stride], temp_histo[threadIdx.x * 192 + 58]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 59) + stride], temp_histo[threadIdx.x * 192 + 59]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 60) + stride], temp_histo[threadIdx.x * 192 + 60]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 61) + stride], temp_histo[threadIdx.x * 192 + 61]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 62) + stride], temp_histo[threadIdx.x * 192 + 62]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 63) + stride], temp_histo[threadIdx.x * 192 + 63]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 64) + stride], temp_histo[threadIdx.x * 192 + 64]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 65) + stride], temp_histo[threadIdx.x * 192 + 65]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 66) + stride], temp_histo[threadIdx.x * 192 + 66]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 67) + stride], temp_histo[threadIdx.x * 192 + 67]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 68) + stride], temp_histo[threadIdx.x * 192 + 68]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 69) + stride], temp_histo[threadIdx.x * 192 + 69]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 70) + stride], temp_histo[threadIdx.x * 192 + 70]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 71) + stride], temp_histo[threadIdx.x * 192 + 71]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 72) + stride], temp_histo[threadIdx.x * 192 + 72]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 73) + stride], temp_histo[threadIdx.x * 192 + 73]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 74) + stride], temp_histo[threadIdx.x * 192 + 74]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 75) + stride], temp_histo[threadIdx.x * 192 + 75]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 76) + stride], temp_histo[threadIdx.x * 192 + 76]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 77) + stride], temp_histo[threadIdx.x * 192 + 77]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 78) + stride], temp_histo[threadIdx.x * 192 + 78]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 79) + stride], temp_histo[threadIdx.x * 192 + 79]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 80) + stride], temp_histo[threadIdx.x * 192 + 80]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 81) + stride], temp_histo[threadIdx.x * 192 + 81]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 82) + stride], temp_histo[threadIdx.x * 192 + 82]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 83) + stride], temp_histo[threadIdx.x * 192 + 83]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 84) + stride], temp_histo[threadIdx.x * 192 + 84]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 85) + stride], temp_histo[threadIdx.x * 192 + 85]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 86) + stride], temp_histo[threadIdx.x * 192 + 86]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 87) + stride], temp_histo[threadIdx.x * 192 + 87]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 88) + stride], temp_histo[threadIdx.x * 192 + 88]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 89) + stride], temp_histo[threadIdx.x * 192 + 89]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 90) + stride], temp_histo[threadIdx.x * 192 + 90]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 91) + stride], temp_histo[threadIdx.x * 192 + 91]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 92) + stride], temp_histo[threadIdx.x * 192 + 92]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 93) + stride], temp_histo[threadIdx.x * 192 + 93]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 94) + stride], temp_histo[threadIdx.x * 192 + 94]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 95) + stride], temp_histo[threadIdx.x * 192 + 95]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 96) + stride], temp_histo[threadIdx.x * 192 + 96]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 97) + stride], temp_histo[threadIdx.x * 192 + 97]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 98) + stride], temp_histo[threadIdx.x * 192 + 98]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 99) + stride], temp_histo[threadIdx.x * 192 + 99]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 100) + stride], temp_histo[threadIdx.x * 192 + 100]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 101) + stride], temp_histo[threadIdx.x * 192 + 101]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 102) + stride], temp_histo[threadIdx.x * 192 + 102]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 103) + stride], temp_histo[threadIdx.x * 192 + 103]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 104) + stride], temp_histo[threadIdx.x * 192 + 104]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 105) + stride], temp_histo[threadIdx.x * 192 + 105]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 106) + stride], temp_histo[threadIdx.x * 192 + 106]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 107) + stride], temp_histo[threadIdx.x * 192 + 107]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 108) + stride], temp_histo[threadIdx.x * 192 + 108]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 109) + stride], temp_histo[threadIdx.x * 192 + 109]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 110) + stride], temp_histo[threadIdx.x * 192 + 110]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 111) + stride], temp_histo[threadIdx.x * 192 + 111]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 112) + stride], temp_histo[threadIdx.x * 192 + 112]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 113) + stride], temp_histo[threadIdx.x * 192 + 113]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 114) + stride], temp_histo[threadIdx.x * 192 + 114]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 115) + stride], temp_histo[threadIdx.x * 192 + 115]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 116) + stride], temp_histo[threadIdx.x * 192 + 116]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 117) + stride], temp_histo[threadIdx.x * 192 + 117]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 118) + stride], temp_histo[threadIdx.x * 192 + 118]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 119) + stride], temp_histo[threadIdx.x * 192 + 119]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 120) + stride], temp_histo[threadIdx.x * 192 + 120]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 121) + stride], temp_histo[threadIdx.x * 192 + 121]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 122) + stride], temp_histo[threadIdx.x * 192 + 122]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 123) + stride], temp_histo[threadIdx.x * 192 + 123]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 124) + stride], temp_histo[threadIdx.x * 192 + 124]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 125) + stride], temp_histo[threadIdx.x * 192 + 125]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 126) + stride], temp_histo[threadIdx.x * 192 + 126]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 127) + stride], temp_histo[threadIdx.x * 192 + 127]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 128) + stride], temp_histo[threadIdx.x * 192 + 128]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 129) + stride], temp_histo[threadIdx.x * 192 + 129]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 130) + stride], temp_histo[threadIdx.x * 192 + 130]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 131) + stride], temp_histo[threadIdx.x * 192 + 131]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 132) + stride], temp_histo[threadIdx.x * 192 + 132]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 133) + stride], temp_histo[threadIdx.x * 192 + 133]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 134) + stride], temp_histo[threadIdx.x * 192 + 134]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 135) + stride], temp_histo[threadIdx.x * 192 + 135]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 136) + stride], temp_histo[threadIdx.x * 192 + 136]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 137) + stride], temp_histo[threadIdx.x * 192 + 137]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 138) + stride], temp_histo[threadIdx.x * 192 + 138]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 139) + stride], temp_histo[threadIdx.x * 192 + 139]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 140) + stride], temp_histo[threadIdx.x * 192 + 140]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 141) + stride], temp_histo[threadIdx.x * 192 + 141]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 142) + stride], temp_histo[threadIdx.x * 192 + 142]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 143) + stride], temp_histo[threadIdx.x * 192 + 143]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 144) + stride], temp_histo[threadIdx.x * 192 + 144]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 145) + stride], temp_histo[threadIdx.x * 192 + 145]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 146) + stride], temp_histo[threadIdx.x * 192 + 146]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 147) + stride], temp_histo[threadIdx.x * 192 + 147]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 148) + stride], temp_histo[threadIdx.x * 192 + 148]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 149) + stride], temp_histo[threadIdx.x * 192 + 149]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 150) + stride], temp_histo[threadIdx.x * 192 + 150]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 151) + stride], temp_histo[threadIdx.x * 192 + 151]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 152) + stride], temp_histo[threadIdx.x * 192 + 152]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 153) + stride], temp_histo[threadIdx.x * 192 + 153]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 154) + stride], temp_histo[threadIdx.x * 192 + 154]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 155) + stride], temp_histo[threadIdx.x * 192 + 155]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 156) + stride], temp_histo[threadIdx.x * 192 + 156]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 157) + stride], temp_histo[threadIdx.x * 192 + 157]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 158) + stride], temp_histo[threadIdx.x * 192 + 158]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 159) + stride], temp_histo[threadIdx.x * 192 + 159]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 160) + stride], temp_histo[threadIdx.x * 192 + 160]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 161) + stride], temp_histo[threadIdx.x * 192 + 161]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 162) + stride], temp_histo[threadIdx.x * 192 + 162]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 163) + stride], temp_histo[threadIdx.x * 192 + 163]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 164) + stride], temp_histo[threadIdx.x * 192 + 164]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 165) + stride], temp_histo[threadIdx.x * 192 + 165]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 166) + stride], temp_histo[threadIdx.x * 192 + 166]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 167) + stride], temp_histo[threadIdx.x * 192 + 167]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 168) + stride], temp_histo[threadIdx.x * 192 + 168]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 169) + stride], temp_histo[threadIdx.x * 192 + 169]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 170) + stride], temp_histo[threadIdx.x * 192 + 170]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 171) + stride], temp_histo[threadIdx.x * 192 + 171]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 172) + stride], temp_histo[threadIdx.x * 192 + 172]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 173) + stride], temp_histo[threadIdx.x * 192 + 173]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 174) + stride], temp_histo[threadIdx.x * 192 + 174]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 175) + stride], temp_histo[threadIdx.x * 192 + 175]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 176) + stride], temp_histo[threadIdx.x * 192 + 176]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 177) + stride], temp_histo[threadIdx.x * 192 + 177]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 178) + stride], temp_histo[threadIdx.x * 192 + 178]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 179) + stride], temp_histo[threadIdx.x * 192 + 179]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 180) + stride], temp_histo[threadIdx.x * 192 + 180]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 181) + stride], temp_histo[threadIdx.x * 192 + 181]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 182) + stride], temp_histo[threadIdx.x * 192 + 182]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 183) + stride], temp_histo[threadIdx.x * 192 + 183]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 184) + stride], temp_histo[threadIdx.x * 192 + 184]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 185) + stride], temp_histo[threadIdx.x * 192 + 185]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 186) + stride], temp_histo[threadIdx.x * 192 + 186]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 187) + stride], temp_histo[threadIdx.x * 192 + 187]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 188) + stride], temp_histo[threadIdx.x * 192 + 188]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 189) + stride], temp_histo[threadIdx.x * 192 + 189]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 190) + stride], temp_histo[threadIdx.x * 192 + 190]);
    		atomicAdd(&dev_histo[(threadIdx.x * 192 + 191) + stride], temp_histo[threadIdx.x * 192 + 191]);

    	stride_offset += part_histo_size;
    	stride += part_histo_size;
    	histo_count++;
	}/** end of histo_count while condition **/
}/** end of kernel function **/


void createHisto(float *imgDataBuffer, int imgDataBufferSize, int nbBinsPerDim, int imgSize, int binSize, int *count){
cudaEvent_t hostDeviceStart,hostDeviceStop;
cudaEventCreate( &hostDeviceStart );
cudaEventCreate( &hostDeviceStop );
cudaEventRecord( hostDeviceStart, 0 );
float *dev_imgDataBuffer;
cudaError_t errorOne = cudaMalloc((void**)&dev_imgDataBuffer, imgDataBufferSize*sizeof(float));
if(errorOne != cudaSuccess)
{
  printf("CUDA errorOne: %s\n", cudaGetErrorString(errorOne));
}
cudaMemcpy(dev_imgDataBuffer, imgDataBuffer, imgDataBufferSize*sizeof(float), cudaMemcpyHostToDevice);

int *dev_histo;
cudaMalloc((void**)&dev_histo, nbBinsPerDim*nbBinsPerDim*nbBinsPerDim*sizeof(int));

cudaMemset(dev_histo, 0, nbBinsPerDim*nbBinsPerDim*nbBinsPerDim*sizeof(int));
cudaEventRecord( hostDeviceStop, 0 );
cudaEventSynchronize( hostDeviceStop );
float hostDeviceElapsedTime;
cudaEventElapsedTime( &hostDeviceElapsedTime,hostDeviceStart, hostDeviceStop );
printf( "\nTime to transfer host to device:  %3.1f ms\n", hostDeviceElapsedTime );

int numPixPerThread = 1;
int numElemPerThread = numPixPerThread*3;
int histo_size = nbBinsPerDim*nbBinsPerDim*nbBinsPerDim;
double reqNumThreads = (((imgSize - 1)/numPixPerThread)+1);
size_t printBufferSize = 1048576*100;
cudaDeviceSetLimit(cudaLimitPrintfFifoSize, printBufferSize);
cudaEvent_t start,stop;
cudaEventCreate( &start );
cudaEventCreate( &stop );
cudaEventRecord( start, 0 );
histo_kernel<<<26, 64>>>(histo_size, reqNumThreads, numPixPerThread, numElemPerThread, imgDataBufferSize, dev_imgDataBuffer, nbBinsPerDim, binSize, dev_histo);
cudaEventRecord( stop, 0 );
cudaEventSynchronize( stop );
float elapsedTime;
cudaEventElapsedTime( &elapsedTime,start, stop );
printf( "Time to generate:  %3.1f ms\n", elapsedTime );
cudaThreadSynchronize();
cudaError_t error = cudaGetLastError();
if(error != cudaSuccess)
{
  // print the CUDA error message and exit
  printf("CUDA error: %s\n", cudaGetErrorString(error));
  printf("I am inside");
}
//int histo[nbBinsPerDim*nbBinsPerDim*nbBinsPerDim];
cudaEvent_t deviceToHostStart,deviceToHostStop;
cudaEventCreate( &deviceToHostStart );
cudaEventCreate( &deviceToHostStop );
cudaEventRecord( deviceToHostStart, 0 );
cudaMemcpy(count, dev_histo, nbBinsPerDim * nbBinsPerDim * nbBinsPerDim*sizeof(int), cudaMemcpyDeviceToHost);
cudaEventRecord( deviceToHostStop, 0 );
cudaEventSynchronize( deviceToHostStop );
float deviceToHostElapsedTime;
cudaEventElapsedTime( &deviceToHostElapsedTime,deviceToHostStart, deviceToHostStop );
printf( "\nTime to transfer device to host:  %3.1f ms\n", deviceToHostElapsedTime );
cudaFree(dev_histo);
cudaFree(dev_imgDataBuffer);
//return histo;
FILE *histoNonZeroCU;
histoNonZeroCU = fopen("histoNonZeroCU.txt", "a");
for(int i = 0; i < nbBinsPerDim * nbBinsPerDim * nbBinsPerDim; i++){
	if(count[i] != 0)
	fprintf(histoNonZeroCU, "%d) %d \n",i+1, count[i]);
}
fclose(histoNonZeroCU);


}
